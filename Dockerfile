FROM node:18-alpine

ARG SENTRY_DSN
ARG SENTRY_ORG
ARG SENTRY_PROJECT
ARG SENTRY_AUTH_TOKEN
ARG STRAPI_URL
ARG NUXT_MAILGUN_API_KEY
ARG NUXT_TURNSTILE_SECRET_KEY
ARG SENTRY_RELEASE_NAME

ENV SENTRY_DSN=${SENTRY_DSN}
ENV SENTRY_ORG=${SENTRY_ORG}
ENV SENTRY_PROJECT=${SENTRY_PROJECT}
ENV SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}
ENV SENTRY_RELEASE_NAME=${SENTRY_RELEASE_NAME}
ENV STRAPI_URL=${STRAPI_URL}
ENV NUXT_MAILGUN_API_KEY=${NUXT_MAILGUN_API_KEY}
ENV NUXT_TURNSTILE_SECRET_KEY=${NUXT_TURNSTILE_SECRET_KEY}

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .

RUN npm run prisma:generate
RUN npm run build

ENV NUXT_HOST=0.0.0.0
ENV NUXT_PORT=3000

COPY ./docker/entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]

EXPOSE 3000
CMD ["npm", "start"]
